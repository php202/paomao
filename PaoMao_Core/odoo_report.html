<style>
  .bubble-cat-wrapper {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
    background-color: #f5f5f5;
    padding: 1.5rem;
    border-radius: 8px;
    color: #333;
    line-height: 1.5;
  }
  .bubble-cat-wrapper * { box-sizing: border-box; }
  .bubble-cat-wrapper .bubble-cat-card {
    max-width: 920px;
    margin: 0 auto;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    padding: 1.5rem;
  }
  .bubble-cat-wrapper h2,
  .bubble-cat-wrapper h3 { margin: 0 0 0.75rem; }
  .bubble-cat-wrapper h3 { margin-top: 1.25rem; font-size: 1.05rem; }
  .bubble-cat-wrapper .state { padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-size: 1rem;}
  .bubble-cat-wrapper .state.loading { background: #e3f2fd; color: #1565c0; }
  .bubble-cat-wrapper .state.error { background: #ffebee; color: #c62828; }
  .bubble-cat-wrapper .section { margin-bottom: 1.25rem; }
  .bubble-cat-wrapper .store-block {
    border: 1px solid #eee;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
  }
  .bubble-cat-wrapper .kv { display: flex; gap: 0.5rem; flex-wrap: wrap; font-size: 0.95rem; }
  .bubble-cat-wrapper .tag { background: #f0f0f0; padding: 0.15rem 0.5rem; border-radius: 4px; }
  .bubble-cat-wrapper .list { margin: 0.25rem 0 0; padding-left: 1.2rem; }
  .bubble-cat-wrapper .share-box { margin-top: 1rem; }
  .bubble-cat-wrapper .pay-grid { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 0.4rem 0.8rem; margin-top: 0.4rem; }
  .bubble-cat-wrapper .pay-item { font-size: 0.9rem; }
  .bubble-cat-wrapper .two-col-list { column-count: 2; column-gap: 1.5rem; }
  .bubble-cat-wrapper textarea { width: 100%; min-height: 80px; padding: 0.6rem; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; }
  .bubble-cat-wrapper button { margin-top: 0.5rem; padding: 0.5rem 1rem; background: #2196f3; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
  .bubble-cat-wrapper button:disabled { background: #ccc; cursor: not-allowed; }
  .bubble-cat-wrapper .small { font-size: 0.9rem; color: #666; }
</style>

<div class="bubble-cat-wrapper">
  <div class="bubble-cat-card">
    <h2>泡泡日報</h2>
    <div id="status" class="state loading">正在載入…</div>
    <div id="content"></div>
  </div>
</div>

<script>
  (function () {
    var GAS_BASE_URL = "https://script.google.com/macros/s/AKfycby5ibTcUxvPD-Xj1-lOHOJ5oI27CbyyaHv2K3cvNd1PwMiPvwGCpjlzi6UbW4fwip2UaA/exec";

    function getToken() {
      var params = new URLSearchParams(window.location.search);
      return params.get("token") || "";
    }

    function showError(msg) {
      var el = document.getElementById("status");
      if (!el) return;
      el.className = "state error";
      el.textContent = msg;
    }

    function clearStatus() {
      var el = document.getElementById("status");
      if (el) el.style.display = "none";
    }

    function renderStoreBlock(store, dateText) {
      var adv = store.advancedCounts || {};
      var empAdv = store.employeeAdvancedCounts || {};
      var pay = store.paymentSummary || null;
      var advOrder = ["活氧", "晶淨", "嘟唇", "逆齡", "頸緻"];
      var advTags = advOrder.filter(function (k) { return adv[k]; })
        .map(function (k) { return '<span class="tag">' + k + ': ' + adv[k] + '</span>'; }).join(" ");
      var empLines = Object.keys(empAdv).map(function (k) {
        var courseMap = empAdv[k] || {};
        var parts = Object.keys(courseMap).map(function (c) { return c + ":" + courseMap[c]; }).join(" ");
        return '<li>' + k + (parts ? (" " + parts) : "") + '</li>';
      }).join("");
      var payHtml = "";
      if (pay) {
        payHtml =
          '<div class="pay-grid">' +
            '<div class="pay-item">現金總額(勿動)：' + pay.cashTotal + '</div>' +
            '<div class="pay-item">消費紀錄(現金)：' + pay.cashBusiness + '</div>' +
            '<div class="pay-item">儲值(現金)：' + pay.cashUnearn + '</div>' +
            '<div class="pay-item">第三方支付總額(勿動)：' + pay.thirdPayTotal + '</div>' +
            '<div class="pay-item">消費紀錄(轉帳)：' + pay.transferRecord + '</div>' +
            '<div class="pay-item">消費紀錄(line)：' + pay.lineRecord + '</div>' +
            '<div class="pay-item">儲值(轉帳)：' + pay.transferUnearn + '</div>' +
            '<div class="pay-item">儲值(line)：' + pay.lineUnearn + '</div>' +
            '<div class="pay-item">業績：' + (pay.todayService || 0) + '</div>' +
          '</div>';
      }
      return (
        '<div class="store-block">' +
          '<div><strong>' + store.storeName + '</strong>' + (dateText ? (' <span class="small">(' + dateText + ')</span>') : '') + '</div>' +
          (payHtml ? ('<div class="small" style="margin-top:0.4rem;">金流摘要</div>' + payHtml) : '') +
          '<div class="kv">' +
            '<span class="tag">平均客單價: ' + (store.avgTicket || 0) + '</span>' +
            '<span class="tag">訂單數: ' + (store.orderCount || 0) + '</span>' +
          '</div>' +
          '<div class="kv" style="margin-top:0.4rem;">' + advTags + '</div>' +
          '<div style="margin-top:0.4rem;">同事進階課程件數</div>' +
          '<ul class="list two-col-list">' + (empLines || "<li>無資料</li>") + '</ul>' +
        '</div>'
      );
    }

    function renderTopCourses(topCourses) {
      if (!topCourses) return "";
      var keys = Object.keys(topCourses);
      if (!keys.length) return "";
      var html = '<div class="section"><h3>全台泡泡貓本日推廣排名</h3>';
      keys.forEach(function (k) {
        var list = topCourses[k] || [];
        if (!list.length) return;
        var items = list.map(function (x, idx) {
          return '<li>No.' + (idx + 1) + ' ' + x.storeName + '：' + x.count + '</li>';
        }).join("");
        html += '<div><strong>' + k + '</strong><ul class="list">' + items + '</ul></div>';
      });
      html += '</div>';
      return html;
    }

    function renderTopAvgTicket(list) {
      if (!list || !list.length) return "";
      var items = list.map(function (x) {
        var stores = (x.stores && x.stores.length) ? ("（" + x.stores.join("、") + "）") : "";
        var name = x.employeeName ? (" " + x.employeeName) : "";
        return '<li>' + x.employeeCode + name + '：' + x.avgTicket + ' / ' + x.orderCount + ' 單 ' + stores + '</li>';
      }).join("");
      return '<div class="section"><h3>全品牌平均客單 Top5</h3><ul class="list">' + items + '</ul></div>';
    }

    function renderGlobalAvg(avg) {
      if (avg == null) return "";
      return '<div class="section"><strong>全台泡泡貓：平均客單價</strong> ' + avg + '</div>';
    }

    function renderShareForm(sessionId) {
      if (!sessionId) return "";
      return (
        '<div class="section share-box">' +
          '<h3>心得分享</h3>' +
          '<div class="small">僅全品牌平均客單前五名可填寫。</div>' +
          '<textarea id="share-content" maxlength="1500" placeholder="輸入你的心得分享…"></textarea>' +
          '<button type="button" id="share-btn">送出</button>' +
          '<div id="share-msg" class="small"></div>' +
        '</div>'
      );
    }

    function bindShare(sessionId) {
      var btn = document.getElementById("share-btn");
      var textarea = document.getElementById("share-content");
      var msg = document.getElementById("share-msg");
      if (!btn || !textarea || !msg) return;
      btn.addEventListener("click", function () {
        var content = textarea.value.trim();
        if (!content) {
          msg.textContent = "請輸入心得內容。";
          return;
        }
        btn.disabled = true;
        msg.textContent = "送出中…";
        var url = GAS_BASE_URL + (GAS_BASE_URL.indexOf("?") >= 0 ? "&" : "?") +
          "action=submitReportShare&sessionId=" + encodeURIComponent(sessionId) +
          "&content=" + encodeURIComponent(content);
        fetch(url, { method: "GET", redirect: "follow" })
          .then(function (res) { return res.json(); })
          .then(function (json) {
            if (json && json.status === "ok") {
              msg.textContent = "已送出心得，等待審核。";
              textarea.value = "";
            } else {
              msg.textContent = (json && json.message) ? json.message : "送出失敗";
            }
          })
          .catch(function () {
            msg.textContent = "送出失敗，請稍後再試。";
          })
          .then(function () { btn.disabled = false; });
      });
    }

    var token = getToken();
    if (!token) {
      showError("請確認網址含有 token 參數 (例如: ?token=...)");
      return;
    }
    if (GAS_BASE_URL.indexOf("你的部署ID") !== -1) {
      showError("設定錯誤：請編輯嵌入程式碼，將 'GAS_BASE_URL' 替換為您真實的 GAS 網址。");
      return;
    }

    var fetchUrl = GAS_BASE_URL + (GAS_BASE_URL.indexOf("?") >= 0 ? "&" : "?") +
      "action=consumeReportToken&token=" + encodeURIComponent(token);

    fetch(fetchUrl, { method: "GET", redirect: "follow" })
      .then(function (res) { return res.json(); })
      .then(function (json) {
        if (!json || json.status !== "ok") {
          showError((json && json.message) ? json.message : "連結已失效");
          return;
        }
        clearStatus();
        var content = document.getElementById("content");
        if (!content) return;
        var html = "";
        if (json.role === "manager") {
          var daily = (json.data && json.data.daily) ? json.data.daily : [];
          html += '<div class="section"><h3>當月日報清單</h3></div>';
          daily.forEach(function (d) {
            var dateText = (d.dateStr && String(d.dateStr).indexOf("GMT") >= 0) ? new Date(d.dateStr).toISOString().slice(0, 10) : (d.dateStr || "");
            html += '<div class="section">';
            (d.stores || []).forEach(function (s) { html += renderStoreBlock(s, dateText); });
            html += renderTopCourses(d.topCourses);
            html += renderGlobalAvg(d.globalAvgTicket);
            html += '</div>';
          });
        } else {
          html += '<div class="section"><h3>今日日報</h3></div>';
          var dateText = json.data && json.data.dateStr ? String(json.data.dateStr) : "";
          (json.data && json.data.stores || []).forEach(function (s) { html += renderStoreBlock(s, dateText); });
          html += renderTopCourses(json.data ? json.data.topCourses : null);
          html += renderGlobalAvg(json.data ? json.data.globalAvgTicket : null);
          html += renderTopAvgTicket(json.topAvgTicketEmployees);
          if (json.canShare && json.shareSessionId) {
            html += renderShareForm(json.shareSessionId);
          }
        }
        content.innerHTML = html;
        if (json.canShare && json.shareSessionId) bindShare(json.shareSessionId);
      })
      .catch(function () {
        showError("連線失敗，請稍後再試。");
      });
  })();
</script>
