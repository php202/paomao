# 使用目前新增／修復的 CRM 功能 — 你要做的事

目前修復與新增的邏輯都在 **CustomerProfile.js**（無效手機處理、寫入列數對齊、整表重整時略過無效手機）。要正常使用，請依序做下面幾件事。

---

## 1. 把程式推到 Google Apps Script（必做）

在終端機執行：

```bash
cd /Users/yutsunghan/node_express/gas/各店訊息一覽表
clasp push
```

這樣本機的 `CustomerProfile.js` 會同步到「各店訊息一覽表」這個 GAS 專案，之後在 GAS 裡執行的就是新邏輯。

---

## 2. 確認試算表權限（避免「無權限存取」）

以下試算表必須**和執行 GAS 的 Google 帳號同一個**，或已分享編輯權給該帳號：

| 用途 | 試算表 ID | 說明 |
|------|-----------|------|
| 客人消費狀態（主表） | `1ZV_0vjtQylyEWrrB5n05fBvvQiDoexYvFuztje1Fgm0` | 泡泡貓｜line@訊息回覆一覽表，內有工作表「客人消費狀態」 |
| 員工填寫 | 同上 | 工作表「表單回覆 3」 |
| 客人問卷 | `1wAfl4Dipag6Eh8msOYUc0ZUepaeQR_HnQNEcxIVUt3M` | 工作表 sheet1、2025前 |
| 訊息一覽 | 同上（與客人消費狀態同份） | 工作表「訊息一覽」 |

若沒權限，會出現 `Exception: You do not have permission to access the document`。

---

## 3. 在 GAS 裡執行一次「整表重整」（建議）

推送完成後，到 **Apps Script 編輯器**（各店訊息一覽表專案）：

1. 選函式：**`refreshAllCustomersByPhone`**
2. 按「執行」

或在本機用：

```bash
cd /Users/yutsunghan/node_express/gas/各店訊息一覽表
clasp run refreshAllCustomersByPhone
```

這會依「客人消費狀態」表裡每一列的手機，重新拉員工填寫、客人問卷、訊息一覽、SayDou，並更新該列（含 C/D 欄與 ai prompt）。  
執行完到試算表「客人消費狀態」檢查：  
- 有有效手機的列應被更新  
- 無效或空手機的列會被略過，不再出現「無效手機 undefined」  
- 若出現列數不符錯誤，目前程式已修正為寫入前對齊欄數，理論上不應再發生  

（若要只測一筆，可選 **`refreshCustomerByPhone`**，並在參數傳入一個正規化後的手機字串。）

---

## 4. 如何把 Triggers 加入排程表（一鍵建立所有排程）

1. 開啟 **Google Apps Script** 編輯器（各店訊息一覽表專案）。
2. 左側檔案選 **Triggers.js**。
3. 上方「選取函式」下拉選 **`setupAllTriggers`**。
4. 按 **▶ 執行**。
5. 第一次會要求授權：按「審查權限」→ 選你的 Google 帳號 → 「進階」→ 「前往各店訊息一覽表」→ 「允許」。
6. 執行完成後，到 **編輯 → 目前專案的觸發條件**，應會看到 **6 個**時間驅動觸發：
   - 每日 21:00：`runDailyCustomerUpdate`
   - 每日 22:00：`refreshCustomersByTomorrowReservations`
   - 每日 8:00：`runTomorrowReservationReportAndPush`
   - 每日 8:30：`runYesterdaySalesReportAndPush`
   - 每月 1 號 8:00：`runMonthlySalesReportAndPush`
   - **每 2 分鐘**：`checkTimeoutPending`（Pending 巡航）

之後若要改排程時間，可改 **Triggers.js** 裡的 `TRIGGERS_CONFIG`，再執行一次 `setupAllTriggers` 即可（會先刪除同函式的舊觸發再建立新的）。

---

## 5. 之後怎麼觸發這些功能（選用）

- **手動整表更新**：需要時在 GAS 編輯器選 `refreshAllCustomersByPhone` 執行。
- **表單送出時自動寫入一筆**：在 GAS「觸發條件」綁定「從試算表」→「 On form submit」→ 選「表單回覆 3」對應的試算表 → 函式選 **`onFormSubmit_Survey`**（只需設一次）。
- **Pending 巡航**：已由 `setupAllTriggers` 建立「每 2 分鐘」`checkTimeoutPending`，會對**所有**準客挽留清單 D=Pending、逾 3 分鐘的列代發 Reply（不再限 Robby Yu）。

---

## 6. 本機檢查表頭與設定（選用）

在 **node_express** 根目錄執行：

```bash
node gas/validate.js
```

會檢查「客人消費狀態」表頭（INTEGRATED_HEADERS）與相關 CONFIG 是否符合 `gas/samples/expected_客人消費狀態.md`，通過會顯示「全部通過」。

---

## 總結：最少要做的事（含排程）

1. **`cd gas/各店訊息一覽表` → `clasp push`**（把新程式推上去）  
2. **確認上述試算表都有權限**  
3. **在 GAS 執行一次 `refreshAllCustomersByPhone`**（或單筆 `refreshCustomerByPhone`）  
4. **在 GAS 選 `setupAllTriggers` 執行一次**（把排程加入觸發條件，含 Pending 巡航每 2 分鐘）

做完以上，目前新增／修復的功能與排程即可正常使用。
